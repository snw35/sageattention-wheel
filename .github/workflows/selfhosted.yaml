name: Self-hosted wheelhouse

on:
  push:
    branches: [ "master", "main", "mainline" ]
  workflow_dispatch:
    inputs:
      skip_publish_release:
        description: "Skip upload wheelhouse to the latest release (default: false)"
        type: boolean
        required: false
        default: false
      skip_upload_artifact:
        description: "Skip upload wheelhouse as a workflow artifact (default: false)"
        type: boolean
        required: false
        default: false

permissions:
  contents: write

jobs:
  build-wheelhouse:
    runs-on: [self-hosted, gpu]
    timeout-minutes: 180
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify GPU availability
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v nvidia-smi >/dev/null 2>&1; then
            echo "nvidia-smi not found; GPU drivers may be missing."
            exit 1
          fi
          if ! nvidia-smi -L >/dev/null 2>&1; then
            echo "No NVIDIA GPUs detected by nvidia-smi."
            exit 1
          fi
          min_cuda="13.1"
          cuda_version="$(nvidia-smi | awk -F 'CUDA Version: ' 'NF>1 {print $2}' | awk '{print $1}' | head -n1)"
          if [ -z "${cuda_version}" ]; then
            echo "Unable to determine CUDA version from nvidia-smi output."
            exit 1
          fi
          if [ "$(printf '%s\n' "${min_cuda}" "${cuda_version}" | sort -V | head -n1)" != "${min_cuda}" ]; then
            echo "CUDA ${cuda_version} detected; requires ${min_cuda} or newer."
            exit 1
          fi

      - name: Prepare wheelhouse directory
        run: |
          rm -rf wheelhouse
          mkdir -p wheelhouse
          chmod -R a+rwx wheelhouse

      - name: Run docker compose
        shell: bash
        run: |
          set -euo pipefail
          if docker compose version >/dev/null 2>&1; then
            compose() { docker compose "$@"; }
          elif command -v docker-compose >/dev/null 2>&1; then
            compose() { docker-compose "$@"; }
          else
            echo "Neither 'docker compose' nor 'docker-compose' is available."
            exit 1
          fi
          trap 'compose down --remove-orphans' EXIT
          run_service() {
            local service="$1"
            compose up --pull always --remove-orphans --abort-on-container-exit --exit-code-from "${service}" "${service}"
            compose down --remove-orphans
          }
          run_service sageattention-wheel-cu12
          run_service sageattention-wheel-cu13

      - name: Filter wheelhouse files under 2 GiB
        shell: bash
        run: |
          set -euo pipefail
          max_bytes=$((2 * 1024 * 1024 * 1024))
          filtered="wheelhouse_upload"
          rm -rf "${filtered}"
          mkdir -p "${filtered}"
          skipped=0
          copied=0
          while IFS= read -r -d '' file; do
            size="$(stat -c %s "${file}")"
            if [ "${size}" -ge "${max_bytes}" ]; then
              echo "Skipping ${file} (${size} bytes) >= 2 GiB."
              skipped=$((skipped + 1))
              continue
            fi
            cp -v "${file}" "${filtered}/"
            copied=$((copied + 1))
          done < <(find wheelhouse -maxdepth 1 -type f -print0)
          if [ "${copied}" -eq 0 ]; then
            echo "Warning: no wheelhouse files under 2 GiB to upload."
            if [ "${skipped}" -gt 0 ]; then
              echo "All ${skipped} wheelhouse files were skipped for being >= 2 GiB."
            fi
          fi

      - name: Upload wheelhouse artifact
        if: ${{ !inputs.skip_upload_artifact }}
        uses: actions/upload-artifact@v4
        with:
          name: wheelhouse
          path: wheelhouse_upload
          if-no-files-found: warn

      - name: Upload wheelhouse to latest release
        if: ${{ !inputs.skip_publish_release && github.ref_name == github.event.repository.default_branch }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            const MAX_BYTES = 2 * 1024 * 1024 * 1024;

            const { owner, repo } = context.repo;
            const { data: release } = await github.rest.repos.getLatestRelease({ owner, repo });
            const release_id = release.id;

            const wheelhouse = path.join(process.env.GITHUB_WORKSPACE, "wheelhouse_upload");
            if (!fs.existsSync(wheelhouse)) {
              core.setFailed(`wheelhouse directory not found at ${wheelhouse}`);
              return;
            }

            const files = fs.readdirSync(wheelhouse).filter((name) =>
              fs.statSync(path.join(wheelhouse, name)).isFile()
            );
            if (files.length === 0) {
              core.warning("wheelhouse directory is empty; nothing to upload.");
              return;
            }

            const assets = await github.paginate(github.rest.repos.listReleaseAssets, {
              owner,
              repo,
              release_id,
              per_page: 100,
            });
            const existing = new Map(assets.map((asset) => [asset.name, asset.id]));

            for (const name of files) {
              const filePath = path.join(wheelhouse, name);
              const size = fs.statSync(filePath).size;
              if (size >= MAX_BYTES) {
                core.info(`Skipping ${name}: ${size} bytes >= 2 GiB.`);
                continue;
              }
              if (existing.has(name)) {
                await github.rest.repos.deleteReleaseAsset({
                  owner,
                  repo,
                  asset_id: existing.get(name),
                });
              }

              const data = fs.readFileSync(filePath);
              await github.rest.repos.uploadReleaseAsset({
                owner,
                repo,
                release_id,
                name,
                data,
                headers: {
                  "content-type": "application/octet-stream",
                  "content-length": data.length,
                },
              });
            }
